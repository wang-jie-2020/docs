# Gateway

## 路由谓词和过滤

路由包含 ID、目标 URI、谓词集合和过滤器集合。谓词可以理解成匹配HTTP请求任何内容的名词。

### 谓词

结合谓词和过滤器进行转发与否的判断，在微服务中最常见的一种配置是由Nacos服务进行统一发现转发：

```yml
- id: xxx
  uri: xxx
  predicates:
    - Path=/system/**
  filters:
    - StripPrefix=1
```

上述的意思是: 请求URL中满足PATH匹配条件的，经过StripPrefix过滤（1指的是网页分段index，比如/system/user即请求user-controller）转发到目标uri

预构建谓词中有非常多，似乎不太需要关注（自定义 可集成AbstractRoutePredicateFactory）

### 过滤器

过滤器包含了过滤器工厂、全局过滤器两个实现，两者的函数签名、逻辑都相似，区别在于字面意义上的特定存在、全局

1. 过滤器工厂继承自`AbstractGatewayFilterFactory`, 在Config上稍微堵了一会注意构造函数。当然不是唯一写法，自己写配置类再注入也行（注意要考虑运行刷新）

```java
@Component
public class BlackListFilter extends AbstractGatewayFilterFactory<BlackListFilter.Config> {

    /// 注意:不能少, 否则会传递Object到bind()绑定不了
    public BlackListFilter() {
        super(Config.class);
    }

    @Override
    public GatewayFilter apply(BlackListFilter.Config config) {

        return (exchange, chain) -> {

            String url = exchange.getRequest().getURI().getPath();
            if (config.matchBlacklist(url))
            {
                ServerHttpResponse response = exchange.getResponse();

                response.setStatusCode(HttpStatus.OK);
                response.getHeaders().add(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE);

                R<?> result = R.fail(R.fail(), "请求地址不允许访问");
                DataBuffer dataBuffer = response.bufferFactory().wrap(JSON.toJSONString(result).getBytes());
                return response.writeWith(Mono.just(dataBuffer));
            }

            return chain.filter(exchange);
        };
    }

    /// config 会从配置中的args带过来
    public static class Config {
        private List<String> blacklistUrl;

        private List<Pattern> blacklistUrlPattern = new ArrayList<>();

        public boolean matchBlacklist(String url)
        {
            return !blacklistUrlPattern.isEmpty() && blacklistUrlPattern.stream().anyMatch(p -> p.matcher(url).find());
        }

        public List<String> getBlacklistUrl()
        {
            return blacklistUrl;
        }

        public void setBlacklistUrl(List<String> blacklistUrl)
        {
            this.blacklistUrl = blacklistUrl;
            this.blacklistUrlPattern.clear();
            this.blacklistUrl.forEach(url -> {
                this.blacklistUrlPattern.add(Pattern.compile(url.replaceAll("\\*\\*", "(.*?)"), Pattern.CASE_INSENSITIVE));
            });
        }
    }
}
```

```yml
        - id: project-system
          uri: lb://project-system
          predicates:
            - Path=/system/**
          filters:
            - StripPrefix=1
            - name: BlackListFilter
              args:
                blacklistUrl:
                  - /user/password/*
                  - /user/profile/*
```





AbstractGatewayFilterFactory vs GlobalFilter

CacheRequestBody





