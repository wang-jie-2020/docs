(window.webpackJsonp=window.webpackJsonp||[]).push([[61],{384:function(t,s,a){"use strict";a.r(s);var n=a(4),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"前置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#前置"}},[t._v("#")]),t._v(" 前置")]),t._v(" "),s("p",[t._v("通过"),s("code",[t._v("DelegatingFilterProxy")]),t._v(" 嵌入 "),s("code",[t._v("SecurityFilterChain")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/wang-jie-2020/images/v2-e8db1153feba42975920dc7d1c33661f_720w.webp",alt:"img"}})]),t._v(" "),s("h2",{attrs:{id:"处理链路"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#处理链路"}},[t._v("#")]),t._v(" 处理链路")]),t._v(" "),s("h3",{attrs:{id:"认证过程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#认证过程"}},[t._v("#")]),t._v(" 认证过程")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/wang-jie-2020/images/v2-700d7fdce90099c6f2d4c9873eaa5259_720w.webp",alt:"img"}})]),t._v(" "),s("p",[t._v("上述过程:")]),t._v(" "),s("ol",[s("li",[t._v("请求经过Chain中过滤器, 构建出了一个Authentication(相当于Principal)")]),t._v(" "),s("li",[t._v("AuthenticationManager 校验Authentication是否合法")]),t._v(" "),s("li",[t._v("Success时保存到SecurityContextHolder,执行成功处理")]),t._v(" "),s("li",[t._v("Failure时,执行失败处理")])]),t._v(" "),s("p",[t._v("详细的过程如下(默认,实际上目前的主流是从jwt中直接以token的方式避免掉多余的认证过程):")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/wang-jie-2020/images/a9c87d1851a94259ac2c603e75c39b2c.png",alt:"img"}})]),t._v(" "),s("p",[t._v("AuthenticationManager如下:")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/wang-jie-2020/images/a7013f51aa6d4cc88468e4d1ab93c888.png",alt:"在这里插入图片描述"}})]),t._v(" "),s("p",[t._v("也就是说具体的认证过程实际是在 UserDetailsService. 如果认证通过, 信息会存入SecurityContextHolder")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/wang-jie-2020/images/v2-ccd782380492892f01fcdca08a5eebd7_720w.webp",alt:"img"}})]),t._v(" "),s("p",[t._v("Authentication 即认证结果,类似于Identity,最终存于 "),s("code",[t._v("SecurityContextHolder")])]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("interface")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Authentication")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Principal")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Serializable")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Collection")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("GrantedAuthority")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getAuthorities")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getCredentials")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getDetails")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getPrincipal")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isAuthenticated")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setAuthenticated")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" isAuthenticated"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IllegalArgumentException")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Authentication")]),t._v(" authentication "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SecurityContextHolder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getContext")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getAuthentication")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Identity")]),t._v(" identity "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Identity")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" authentication"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getPrincipal")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br")])]),s("h2",{attrs:{id:"鉴权"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#鉴权"}},[t._v("#")]),t._v(" 鉴权")]),t._v(" "),s("p",[t._v("@preAuthorize")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/wang-jie-2020/images/image-20230925140657233.png",alt:"image-20230925140657233"}})]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[s("strong",[t._v("表达式")])]),t._v(" "),s("th",[s("strong",[t._v("描述")])])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("hasRole([role])")]),t._v(" "),s("td",[t._v("当前用户是否拥有指定角色。")])]),t._v(" "),s("tr",[s("td",[t._v("hasAnyRole([role1,role2])")]),t._v(" "),s("td",[t._v("多个角色是一个以逗号进行分隔的字符串。如果当前用户拥有指定角色中的任意一个则返回true。")])]),t._v(" "),s("tr",[s("td",[t._v("hasAuthority([auth])")]),t._v(" "),s("td",[t._v("等同于hasRole")])]),t._v(" "),s("tr",[s("td",[t._v("hasAnyAuthority([auth1,auth2])")]),t._v(" "),s("td",[t._v("等同于hasAnyRole")])]),t._v(" "),s("tr",[s("td",[t._v("Principle")]),t._v(" "),s("td",[t._v("代表当前用户的principle对象")])]),t._v(" "),s("tr",[s("td",[t._v("authentication")]),t._v(" "),s("td",[t._v("直接从SecurityContext获取的当前Authentication对象")])]),t._v(" "),s("tr",[s("td",[t._v("permitAll")]),t._v(" "),s("td",[t._v("总是返回true，表示允许所有的")])]),t._v(" "),s("tr",[s("td",[t._v("denyAll")]),t._v(" "),s("td",[t._v("总是返回false，表示拒绝所有的")])]),t._v(" "),s("tr",[s("td",[t._v("isAnonymous()")]),t._v(" "),s("td",[t._v("当前用户是否是一个匿名用户")])]),t._v(" "),s("tr",[s("td",[t._v("isRememberMe()")]),t._v(" "),s("td",[t._v("表示当前用户是否是通过Remember-Me自动登录的")])]),t._v(" "),s("tr",[s("td",[t._v("isAuthenticated()")]),t._v(" "),s("td",[t._v("表示当前用户是否已经登录认证成功了。")])]),t._v(" "),s("tr",[s("td",[t._v("isFullyAuthenticated()")]),t._v(" "),s("td",[t._v("如果当前用户既不是一个匿名用户，同时又不是通过Remember-Me自动登录的，则返回true。")])])])]),t._v(" "),s("p",[t._v("实际项目直接基于Role的鉴权结构比较少,通常都是限定权限常量是否包含在授权列表中(更细节一些).")]),t._v(" "),s("p",[t._v("hasAuthority、hasPermission实际上都是从Authentication中的Authorities中判断.")]),t._v(" "),s("p",[t._v("RuoYi中考虑的是方法级的认证,通过注解启用@preAuthorize")]),t._v(" "),s("p",[s("code",[t._v("@EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)")])]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@PreAuthorize")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"@ss.hasPermi('system:menu:list')\"")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 其中的ss即指定命名的Bean")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Service")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ss"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("PermissionService")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br")])]),s("h2",{attrs:{id:"jwt"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#jwt"}},[t._v("#")]),t._v(" JWT")]),t._v(" "),s("p",[t._v("大致逻辑是: filterChain中嵌入自定义tokenFilter(UsernamePasswordAuthenticationFilter之前), 通过token拿到信息包装之后即可.")]),t._v(" "),s("p",[t._v("在这个过程之前的登录 可以通过实现UserDetailsService来进行验证过程(这不是强制必要的)")]),t._v(" "),s("h2",{attrs:{id:"跨域"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#跨域"}},[t._v("#")]),t._v(" 跨域")]),t._v(" "),s("p",[t._v("在spring-mvc中的WebMvcConfigurer.addCorsMappings()中可以做到跨域")]),t._v(" "),s("p",[t._v("但一旦和SpringSecurity结合使用就不能正常运行,这个结果是因为SpringSecurity注册的过滤器拦截了跨域的预检请求(到不了spring中)")]),t._v(" "),s("p",[t._v("1.不使用mvc的配置,而是通过CorsFilter的Bean")]),t._v(" "),s("p",[t._v("2.httpSecurity.addFilterBefore(corsFilter, JwtAuthenticationTokenFilter.class);")])])}),[],!1,null,null,null);s.default=e.exports}}]);