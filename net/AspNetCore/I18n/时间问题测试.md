[地区编码](https://www.cnblogs.com/JayChristopher/p/9804353.html)

https://www.iana.org/time-zones

https://learn.microsoft.com/zh-cn/dotnet/api/system.timezoneinfo?view=net-9.0



故事的背景是海外推广，对于语言的国际化方式可以确定，对于日期的国际化方式拿捏不定：

1. 前端的时间要么是本地时间要么是UTC时间，无论是moment还是el-date都有方式，如果填写的不是时间而是日期？
2. 保存DateTimeOffset --- 存储带时区的时间是最佳做法；保存DateTime --- 存储本地时间，再以约定显示
3. **语言和时区捆绑 或 语言和时区不捆绑**

1. 1. **如果不捆绑，只需要考虑服务端传前端的的一次LOCAL转换，在WriteJson时将本地时间转为UTC或者目标系统时间即可满足**
   2. **如果捆绑，前端传递服务端时有一次LOCAL转换，服务端转前端时一次LOCAL转换**

## DateTime vs DateTimeOffset

DateTimeOffset = DateTime + TimeZone

DateTime -> DateTimeOffset , Local and Unspecified are both treated as Local  --- 通过构造函数可以看到的注释

某种程度上不必纠结，直接可以将时间当作系统`本地时间`考虑，只是在转换时的附加方法或者参数不一样

### 数据库中的DateTime

不包含时区概念，也不含UTC和LOCAL，直接保存。

### DateTimeOffset

- MySQL    	timestamp（和session的时区相关，测试时未附加Timezone）
- SQLServer    	DateTimeOffset
- Oracle    		timestamp with time zone

```csharp
var r = new DateTimeOffsetDemo()
{
    Time11 = DateTimeOffset.Now,
    Time12 = DateTimeOffset.UtcNow,
    Time13 = TimeZoneInfo.ConvertTimeBySystemTimeZoneId(DateTimeOffset.Now, TimeZoneConst.US),
    Time14 = TimeZoneInfo.ConvertTimeBySystemTimeZoneId(DateTimeOffset.UtcNow, TimeZoneConst.US)
};

_msSqlContext.DateTimeOffsetDemos.Add(r);
_msSqlContext.SaveChanges();

var i = _msSqlContext.DateTimeOffsetDemos.OrderBy(t => t.Id).Last();

var o = new
{
    Time11 = TimeZoneInfo.ConvertTimeBySystemTimeZoneId(i.Time11 ?? throw new NullReferenceException(), TimeZoneConst.JP),
    Time12 = TimeZoneInfo.ConvertTimeBySystemTimeZoneId(i.Time12 ?? throw new NullReferenceException(), TimeZoneConst.JP),

    Time13 = TimeZoneInfo.ConvertTimeBySystemTimeZoneId(i.Time13 ?? throw new NullReferenceException(), TimeZoneConst.JP),
    Time14 = TimeZoneInfo.ConvertTimeBySystemTimeZoneId(i.Time14 ?? throw new NullReferenceException(), TimeZoneConst.JP),
};

return new { r, i, o };
```

|                 | MYSQL | MSSQL | ORACLE |
| --------------- | ----- | ----- | ------ |
| LOCAL-NOW（+8） | +0    | +8    | +8     |
| UTC-NOW（+0）   | +0    | +0    | +0     |
| US-NOW（-5）    | +0    | -5    | -5     |

区别在于在session中的时区会影响到最终的查询结果，但Timing都是一样的。



## 模型绑定

mvcOptions.ModelBinderProviders：

![img](https://cdn.nlark.com/yuque/0/2025/png/1294764/1736753857206-28423e14-0ffc-4149-9229-0969523e3b8c.png)



未进行修改的情况下：

|                               | Query                    | Form                     | Body（NewtonSoftJson影响?）   |
| ----------------------------- | ------------------------ | ------------------------ | ----------------------------- |
| 2025-01-13T04:59:38.502Z      | 2025-01-13T04:59:38.502Z | 2025-01-13T04:59:38.502Z | 2025-01-13T04:59:38.502Z      |
| 2025-01-13T04:59:38.502+00:00 | 2025-01-13T04:59:38.502Z | 2025-01-13T04:59:38.502Z | 2025-01-13T12:59:38.502+08:00 |
| 2025-01-13T04:59:38.502       | 2025-01-13T04:59:38.502  | 2025-01-13T04:59:38.502  | 2025-01-13T04:59:38.502       |



- FromQuery、FromForm 	

从DateTimeModelBinderProvider中得到DateTimeModelBinder，DateTime.TryParse

![img](https://cdn.nlark.com/yuque/0/2025/png/1294764/1736754188725-770a8f56-bb51-40bf-824b-df2bdf9cb767.png)

![img](https://cdn.nlark.com/yuque/0/2025/png/1294764/1736754229749-e2a65fba-8d77-4e78-a7de-acc7a95fdc3f.png)

- FromBody 				

从BodyModelBinderProvider中得到BodyModelBinder，通过注册的IInputFormatter尝试转换，如果附加了NewtonsoftJson则相应的处理就是

![img](https://cdn.nlark.com/yuque/0/2025/png/1294764/1736754567733-4058da1e-f1e8-4a57-af52-7c3ee36ddc5f.png)

![img](https://cdn.nlark.com/yuque/0/2025/png/1294764/1736754667367-1cca4720-c9ba-4d48-b9c5-2707e4be7b49.png)



NET6中的测试结果：

- FromQuery、FromForm 的DateTime的KIND要么是UTC要么是Unspecified
- FromBody 的DateTime的KIND随序列化参数而不同



## NewtonsoftJson结构化输出

https://www.newtonsoft.com/json/help/html/SerializationSettings.htm

![img](https://cdn.nlark.com/yuque/0/2025/png/1294764/1736754845475-d7c40e9f-1740-464c-8919-bc774a868b3a.png)



![img](https://cdn.nlark.com/yuque/0/2025/png/1294764/1736754904117-f5d25a6e-f557-46cb-bac8-2c00814b4419.png)



- DateFormatHandling
- DateFormatString
- DateParseHandling
- DateTimeZoneHandling

DateTimeOffset类型在Json序列化时的表现始终一致，DateTime类型在JSON序列化时的不同表现（在不指定DateFormatString的前提下）

```csharp
var r = new DateTimeDto
{
    DateTimeNow = new DateTime(2025, 1, 10, 9, 0, 0, DateTimeKind.Local),
    DateTimeUtcNow = new DateTime(2025, 1, 10, 1, 0, 0, DateTimeKind.Utc),
    DateTimeUnspecified = new DateTime(2025, 1, 10, 9, 0, 0, DateTimeKind.Unspecified),
};

var jsonLocal = JsonConvert.SerializeObject(r, new JsonSerializerSettings() { DateTimeZoneHandling = DateTimeZoneHandling.Local });
var jsonUtc = JsonConvert.SerializeObject(r, new JsonSerializerSettings() { DateTimeZoneHandling = DateTimeZoneHandling.Utc });
var jsonUnspecified = JsonConvert.SerializeObject(r, new JsonSerializerSettings() { DateTimeZoneHandling = DateTimeZoneHandling.Unspecified });
var jsonRoundtripKind = JsonConvert.SerializeObject(r, new JsonSerializerSettings() { DateTimeZoneHandling = DateTimeZoneHandling.RoundtripKind });
```



| Local                     | Utc                  | Unspecified         | RoundtripKind             |
| ------------------------- | -------------------- | ------------------- | ------------------------- |
| 2025-01-10T09:00:00+08:00 | 2025-01-10T01:00:00Z | 2025-01-10T09:00:00 | 2025-01-10T09:00:00+08:00 |
| 2025-01-10T09:00:00+08:00 | 2025-01-10T01:00:00Z | 2025-01-10T01:00:00 | 2025-01-10T01:00:00Z      |
| 2025-01-10T09:00:00+08:00 | 2025-01-10T09:00:00Z | 2025-01-10T09:00:00 | 2025-01-10T09:00:00       |

Unspecified 的 DateTime 以及 JSON枚举，相当于不会对其转换。



## 测试

测试通过不同的传值方式, 测试输出的JSON

```csharp
  [HttpPost]
    public object InputQueryDateTime([FromQuery] InputDateTime input)
    {
        return input;
    }
    
    [HttpPost]
    public object InputFormDateTime([FromForm] InputDateTime input)
    {
        return input;
    }

    [HttpPost]
    public object InputBodyDateTime([FromBody] InputDateTime input)
    {
        return input;
    }
```

一、在默认情况下

|                                       | Query           | Form            | Body                                     |
| ------------------------------------- | --------------- | --------------- | ---------------------------------------- |
| DateTime 2025-12-24T12:00:00          | T12:00:00       | T12:00:00       | T12:00:00                                |
| DateTime 2025-12-24T12:00:00+08:00    | T04:00:00Z      | T04:00:00Z      | <font color='red'>T12:00:00+08:00</font> |
| DateTimeOffset 2025-12-24T12:00:00    | T12:00:00+08:00 | T12:00:00+08:00 | T12:00:00+08:00                          |
| DateTimeOffset 2025-12-24T12:00:00+08 | T12:00:00+08:00 | T12:00:00+08:00 | T12:00:00+08:00                          |



二、在指定日期格式化Format-"yyyy-MM-dd HH:mm:ss"

|                                          | Query    | Form     | Body     |
| ---------------------------------------- | -------- | -------- | -------- |
| DateTime 2025-12-24T12:00:00             | 12:00:00 | 12:00:00 | 12:00:00 |
| DateTime 2025-12-24T12:00:00+08:00       | 04:00:00 | 04:00:00 | 12:00:00 |
| DateTimeOffset 2025-12-24T12:00:00       | 12:00:00 | 12:00:00 | 12:00:00 |
| DateTimeOffset 2025-12-24T12:00:00+08:00 | 12:00:00 | 12:00:00 | 12:00:00 |



